#include <SoftwareSerial.h>

int RX;
int TX;
SoftwareSerial sensorSerial (RX, TX);
 
uint8_t buffer[25]; 
uint8_t ind =0; 

String oVal = "";
String tVal = "";
String pVal = "";
String %Val = "";
String eVal = "";

void setup () {
Serial.begin (9600);
serial.begin (9600);
analogReference (EXTERNAL); //connect AREF to a 3.3V power supply 
Serial.println ("ppO2 (mBar), temp (C), pressure (mBar), O2 in percent (%), status");
serial.write (“M 0\r\n”); //puts sensor in stream mode
}

void loop () {
while(buffer[ind-1] != 0x0A) 
 { 
    if(serial.available()) 
    { 
    buffer[ind] = serial.read(); 
    ind++; 
    } 
 }
 parse(); 
 printValues();
 }
 
void parse (){
for(int i=0; i < ind+1; i++) 
 { 
     if(buffer[i] == '\r\n')
      break; 
 int c=1;
    
     if(buffer[i] != 0x20) //ignore white space 
      { 
      switch (buffer[i])
      case ('O'){
      c=1; 
      break;
      }
      case ('T'){
      c=2;
      break;
      }
      case ('P'){
      c=3;
      break;
      }
      case ('%'){
      c=4;
      break;
      }
      case ('e'){
      c=5;
      break;
      }
      
      switch (c)
      case 1
      oVal += buffer[i]-48; //oVal represents ppO2 in mBar 
      case 2
      tVal += buffer [i]-48; //tVal represents temp in C
      case 3
      pVal += buffer [i]-48; //pVal represents pressure in mBar
      case 4
      %Val += buffer [i]-48; //%Val represents O2 in percent %
      case 5
      eVal += buffer [i]-48; //represents status - if '0000' then good 
      
      // we subtract 48 to get to the actual numerical value 
      // example the character '9' has an ASCII value of 57. [57-48=9] 
 }
 void printValues()
 {
 String goodVal = "0000";
 Serial.print (oVal);
 Serial.print (", ");
 Serial.print (tVal);
 Serial.print (", ");
 Serial.print (pVal);
 Serial.print (", ");
 Serial.print (%Val);
 Serial.print (", ");
 if (strcmp(eVal,goodVal)!=0)
 Serial.println ("bad");
 else
 Serial.println ("good");
 
}
